(function(host,expose){var module={exports:{}},exports=module.exports,TOKEN_FORMAT={JSON:"application/json",FORM_URL_ENCODED:"application/x-www-form-urlencoded"},STORAGE_PREFIX_="oauth2.";function createService(e){return new Service_(e)}function getRedirectUri(e){var t=e||ScriptApp.getScriptId();return"https://script.google.com/macros/d/"+encodeURIComponent(t)+"/usercallback"}function getServiceNames(e){var t=e.getProperties();return Object.keys(t).filter((function(e){var t=e.split(".");return 0==e.indexOf(STORAGE_PREFIX_)&&t.length>1&&t[1]})).map((function(e){return e.split(".")[1]})).reduce((function(e,t){return e.indexOf(t)<0&&e.push(t),e}),[])}"object"==typeof module&&(module.exports={createService,getRedirectUri,getServiceNames,TOKEN_FORMAT});var Service_=function(e){validate_({"Service name":e}),this.serviceName_=e,this.params_={},this.tokenFormat_=TOKEN_FORMAT.JSON,this.tokenHeaders_=null,this.tokenMethod_="post",this.expirationMinutes_=60};function Storage_(e,t,r){this.prefix_=e,this.properties_=t,this.cache_=r,this.memory_={}}function buildUrl_(e,t){var r=Object.keys(t).map((function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])})).join("&");return e+(e.indexOf("?")>=0?"&":"?")+r}function validate_(e){Object.keys(e).forEach((function(t){if(!e[t])throw new Error(t+" is required.")}))}function getTimeInSeconds_(e){return Math.floor(e.getTime()/1e3)}function extend_(e,t){for(var r=Object.keys(t),i=0;i<r.length;++i)e[r[i]]=t[r[i]];return e}function toLowerCaseKeys_(e){return null===e||"object"!=typeof e?e:Object.keys(e).reduce((function(t,r){return t[r.toLowerCase()]=e[r],t}),{})}function encodeJwt_(e,t){var r=Utilities.base64EncodeWebSafe(JSON.stringify({alg:"RS256",typ:"JWT"}))+"."+Utilities.base64EncodeWebSafe(JSON.stringify(e)),i=Utilities.computeRsaSha256Signature(r,t);return r+"."+Utilities.base64EncodeWebSafe(i)}function decodeJwt_(e){var t=e.split(".")[1],r=Utilities.newBlob(Utilities.base64DecodeWebSafe(t));return JSON.parse(r.getDataAsString())}Service_.EXPIRATION_BUFFER_SECONDS_=60,Service_.LOCK_EXPIRATION_MILLISECONDS_=3e4,Service_.prototype.setAuthorizationBaseUrl=function(e){return this.authorizationBaseUrl_=e,this},Service_.prototype.setTokenUrl=function(e){return this.tokenUrl_=e,this},Service_.prototype.setRefreshUrl=function(e){return this.refreshUrl_=e,this},Service_.prototype.setTokenFormat=function(e){return this.tokenFormat_=e,this},Service_.prototype.setTokenHeaders=function(e){return this.tokenHeaders_=e,this},Service_.prototype.setTokenMethod=function(e){return this.tokenMethod_=e,this},Service_.prototype.setTokenPayloadHandler=function(e){return this.tokenPayloadHandler_=e,this},Service_.prototype.setCallbackFunction=function(e){return this.callbackFunctionName_=e,this},Service_.prototype.setClientId=function(e){return this.clientId_=e,this},Service_.prototype.setClientSecret=function(e){return this.clientSecret_=e,this},Service_.prototype.setPropertyStore=function(e){return this.propertyStore_=e,this},Service_.prototype.setCache=function(e){return this.cache_=e,this},Service_.prototype.setLock=function(e){return this.lock_=e,this},Service_.prototype.setScope=function(e,t){var r=t||" ";return this.params_.scope=Array.isArray(e)?e.join(r):e,this},Service_.prototype.setParam=function(e,t){return this.params_[e]=t,this},Service_.prototype.setPrivateKey=function(e){return this.privateKey_=e,this},Service_.prototype.setIssuer=function(e){return this.issuer_=e,this},Service_.prototype.setAdditionalClaims=function(e){return this.additionalClaims_=e,this},Service_.prototype.setSubject=function(e){return this.subject_=e,this},Service_.prototype.setExpirationMinutes=function(e){return this.expirationMinutes_=e,this},Service_.prototype.setGrantType=function(e){return this.grantType_=e,this},Service_.prototype.setRedirectUri=function(e){return this.redirectUri_=e,this},Service_.prototype.getRedirectUri=function(){return this.redirectUri_||getRedirectUri()},Service_.prototype.getAuthorizationUrl=function(optAdditionalParameters){validate_({"Client ID":this.clientId_,"Callback function name":this.callbackFunctionName_,"Authorization base URL":this.authorizationBaseUrl_});var stateTokenBuilder=eval("ScriptApp").newStateToken().withMethod(this.callbackFunctionName_).withArgument("serviceName",this.serviceName_).withTimeout(3600);optAdditionalParameters&&Object.keys(optAdditionalParameters).forEach((function(e){stateTokenBuilder.withArgument(e,optAdditionalParameters[e])}));var params={client_id:this.clientId_,response_type:"code",redirect_uri:this.getRedirectUri(),state:stateTokenBuilder.createToken()};return params=extend_(params,this.params_),buildUrl_(this.authorizationBaseUrl_,params)},Service_.prototype.handleCallback=function(e){var t=e.parameter.code,r=e.parameter.error;if(r){if("access_denied"==r)return!1;throw new Error("Error authorizing token: "+r)}validate_({"Client ID":this.clientId_,"Client Secret":this.clientSecret_,"Token URL":this.tokenUrl_});var i={code:t,client_id:this.clientId_,client_secret:this.clientSecret_,redirect_uri:this.getRedirectUri(),grant_type:"authorization_code"},o=this.fetchToken_(i);return this.saveToken_(o),!0},Service_.prototype.hasAccess=function(){var e=this.getToken();return!(!e||this.isExpired_(e))||!!(e&&this.canRefresh_(e)||this.privateKey_||this.grantType_)&&this.lockable_((function(){if((e=this.getToken(!0))&&!this.isExpired_(e))return!0;try{return e&&this.canRefresh_(e)?(this.refresh(),!0):this.privateKey_?(this.exchangeJwt_(),!0):!!this.grantType_&&(this.exchangeGrant_(),!0)}catch(e){return this.lastError_=e,!1}}))},Service_.prototype.getAccessToken=function(){if(!this.hasAccess())throw new Error("Access not granted or expired.");return this.getToken().access_token},Service_.prototype.getIdToken=function(){if(!this.hasAccess())throw new Error("Access not granted or expired.");return this.getToken().id_token},Service_.prototype.reset=function(){this.getStorage().reset()},Service_.prototype.getLastError=function(){return this.lastError_},Service_.prototype.fetchToken_=function(e,t){var r=t||this.tokenUrl_,i={Accept:this.tokenFormat_};this.tokenHeaders_&&(i=extend_(i,this.tokenHeaders_)),this.tokenPayloadHandler_&&(e=this.tokenPayloadHandler_(e));var o=UrlFetchApp.fetch(r,{method:this.tokenMethod_,headers:i,payload:e,muteHttpExceptions:!0});return this.getTokenFromResponse_(o)},Service_.prototype.getTokenFromResponse_=function(e){var t=this.parseToken_(e.getContentText()),r=e.getResponseCode();if(r<200||r>=300||t.error){var i=[t.error,t.message,t.error_description,t.error_uri].filter(Boolean).map((function(e){return"string"==typeof e?e:JSON.stringify(e)})).join(", ");throw i||(i=r+": "+JSON.stringify(t)),new Error("Error retrieving token: "+i)}return t},Service_.prototype.parseToken_=function(e){var t;if(this.tokenFormat_==TOKEN_FORMAT.JSON)try{t=JSON.parse(e)}catch(e){throw new Error("Token response not valid JSON: "+e)}else{if(this.tokenFormat_!=TOKEN_FORMAT.FORM_URL_ENCODED)throw new Error("Unknown token format: "+this.tokenFormat_);t=e.split("&").reduce((function(e,t){var r=t.split("=");return e[decodeURIComponent(r[0])]=decodeURIComponent(r[1]),e}),{})}return t.granted_time=getTimeInSeconds_(new Date),t},Service_.prototype.refresh=function(){validate_({"Client ID":this.clientId_,"Client Secret":this.clientSecret_,"Token URL":this.tokenUrl_}),this.lockable_((function(){var e=this.getToken();if(!e.refresh_token)throw new Error("Offline access is required.");var t={refresh_token:e.refresh_token,client_id:this.clientId_,client_secret:this.clientSecret_,grant_type:"refresh_token"},r=this.fetchToken_(t,this.refreshUrl_);r.refresh_token||(r.refresh_token=e.refresh_token),this.saveToken_(r)}))},Service_.prototype.getStorage=function(){if(!this.storage_){var e=STORAGE_PREFIX_+this.serviceName_;this.storage_=new Storage_(e,this.propertyStore_,this.cache_)}return this.storage_},Service_.prototype.saveToken_=function(e){this.getStorage().setValue(null,e)},Service_.prototype.getToken=function(e){return this.getStorage().getValue(null,e)},Service_.prototype.isExpired_=function(e){var t=!1,r=getTimeInSeconds_(new Date),i=e.expires_in_sec||e.expires_in||e.expires;i&&(e.granted_time+Number(i)-r<Service_.EXPIRATION_BUFFER_SECONDS_&&(t=!0));if(e.id_token){var o=decodeJwt_(e.id_token);o.exp&&o.exp-r<Service_.EXPIRATION_BUFFER_SECONDS_&&(t=!0)}return t},Service_.prototype.canRefresh_=function(e){if(!e.refresh_token)return!1;var t=e.refresh_token_expires_in;return!t||e.granted_time+Number(t)-getTimeInSeconds_(new Date)>Service_.EXPIRATION_BUFFER_SECONDS_},Service_.prototype.exchangeJwt_=function(){validate_({"Token URL":this.tokenUrl_});var e={assertion:this.createJwt_(),grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer"},t=this.fetchToken_(e);this.saveToken_(t)},Service_.prototype.createJwt_=function(){validate_({"Private key":this.privateKey_,"Token URL":this.tokenUrl_,"Issuer or Client ID":this.issuer_||this.clientId_});var e=new Date,t=new Date(e.getTime());t.setMinutes(t.getMinutes()+this.expirationMinutes_);var r={iss:this.issuer_||this.clientId_,aud:this.tokenUrl_,exp:Math.round(t.getTime()/1e3),iat:Math.round(e.getTime()/1e3)};if(this.subject_&&(r.sub=this.subject_),this.params_.scope&&(r.scope=this.params_.scope),this.additionalClaims_){var i=this.additionalClaims_;Object.keys(i).forEach((function(e){r[e]=i[e]}))}return encodeJwt_(r,this.privateKey_)},Service_.prototype.lockable_=function(e){var t=!1;this.lock_&&!this.lock_.hasLock()&&(this.lock_.waitLock(Service_.LOCK_EXPIRATION_MILLISECONDS_),t=!0);var r=e.apply(this);return this.lock_&&t&&this.lock_.releaseLock(),r},Service_.prototype.exchangeGrant_=function(){validate_({"Grant Type":this.grantType_,"Token URL":this.tokenUrl_});var e={grant_type:this.grantType_};e=extend_(e,this.params_);var t=toLowerCaseKeys_(this.tokenHeaders_);"client_credentials"!==this.grantType_||!this.clientId_||!this.clientSecret_||t&&t.authorization||(this.tokenHeaders_=this.tokenHeaders_||{},this.tokenHeaders_.authorization="Basic "+Utilities.base64Encode(this.clientId_+":"+this.clientSecret_));var r=this.fetchToken_(e);this.saveToken_(r)},Storage_.CACHE_EXPIRATION_TIME_SECONDS=21600,Storage_.CACHE_NULL_VALUE="__NULL__",Storage_.prototype.getValue=function(e,t){var r,i,o=this.getPrefixedKey_(e);return!t&&(i=this.memory_[o])?i===Storage_.CACHE_NULL_VALUE?null:i:this.cache_&&(r=this.cache_.get(o))?(i=JSON.parse(r),this.memory_[o]=i,i===Storage_.CACHE_NULL_VALUE?null:i):this.properties_&&(r=this.properties_.getProperty(o))?(this.cache_&&this.cache_.put(o,r,Storage_.CACHE_EXPIRATION_TIME_SECONDS),i=JSON.parse(r),this.memory_[o]=i,i):(this.memory_[o]=Storage_.CACHE_NULL_VALUE,this.cache_&&this.cache_.put(o,JSON.stringify(Storage_.CACHE_NULL_VALUE),Storage_.CACHE_EXPIRATION_TIME_SECONDS),null)},Storage_.prototype.setValue=function(e,t){var r=this.getPrefixedKey_(e),i=JSON.stringify(t);this.properties_&&this.properties_.setProperty(r,i),this.cache_&&this.cache_.put(r,i,Storage_.CACHE_EXPIRATION_TIME_SECONDS),this.memory_[r]=t},Storage_.prototype.removeValue=function(e){var t=this.getPrefixedKey_(e);this.removeValueWithPrefixedKey_(t)},Storage_.prototype.reset=function(){var e=this.getPrefixedKey_(),t=Object.keys(this.memory_);if(this.properties_){var r=this.properties_.getProperties();t=Object.keys(r).filter((function(t){return t===e||0===t.indexOf(e+".")}))}for(var i=0;i<t.length;i++)this.removeValueWithPrefixedKey_(t[i])},Storage_.prototype.removeValueWithPrefixedKey_=function(e){this.properties_&&this.properties_.deleteProperty(e),this.cache_&&this.cache_.remove(e),delete this.memory_[e]},Storage_.prototype.getPrefixedKey_=function(e){return e?this.prefix_+"."+e:this.prefix_},function(e,t,r){if(r[t]=r[t]||{},e&&"object"==typeof e)for(var i in e)e.hasOwnProperty(i)&&(r[t][i]=e[i]);else r[t]=e}.call(null,module.exports,expose,host)}).call(this,this,"OAuth2");